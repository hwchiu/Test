pipeline {
    agent {
        docker { image 'ubuntu:18.04' 
                  args '-u root:root -v $HOME/workspace/myproject:/myproject'
            
        }
    }
    environment {
        JJB_CONFIG = credentials('jjb-config')
    }
    triggers {
        githubPush()
    }    
    stages {
        stage('Checkout SCM') {
          steps {
            checkout([
              $class: 'GitSCM',
              branches: [[name: "**" ]],
              userRemoteConfigs: [[
                url: 'https://github.com/hwchiu/test.git',
                credentialsId: '',
              ]]
             ])
           }
        }
        stage('Build Packages') {
            steps {
                sh '''
                apt-get update -y
                apt-get install -y python-pip
                pip install --user jenkins-job-builder
                '''
            }
        }
        stage('Test') {
            steps {
                sh '''
                jenkins-jobs -conf $JJB_CONFIG test test-jjb.yaml
                '''
            }
        }
        stage('Deploy') {
            steps {
                sh '''
                jenkins-jobs -conf $JJB_CONFIG update test-jjb.yaml
                '''
            }
        }

    }
}
